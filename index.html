<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚¹ãƒ†ã‚¤ãƒ›ãƒ¼ãƒ ãƒ„ã‚¢ãƒ¼ã‚º â€” æ—…è¡Œã‚’ã‚„ã‚ã¦å¹¸ã›ã«å¸°ã‚ã†ï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
<style>
/* RESET */
*{margin:0;padding:0;box-sizing:border-box;font-family:"Noto Sans JP",sans-serif;}
html,body{height:100%;}
body{background:#0b0b0b;color:white;overflow-x:hidden;-webkit-font-smoothing:antialiased;}
.wrapper{max-width:1100px;margin:0 auto;padding:20px;width:100%;}

/* HERO */
.hero{text-align:center;padding:48px 10px 36px;}
.hero h1{font-size:2rem;font-weight:800;margin-bottom:8px;letter-spacing:0.6px;}
.hero p{font-size:1rem;opacity:0.9;margin-bottom:12px;}

/* èµ¤è­¦å‘Šãƒœã‚¿ãƒ³ */
#alertToggle{margin-top:12px;padding:10px 20px;font-size:1rem;border:none;border-radius:50px;background:#b30000;color:white;cursor:pointer;animation:glow 2s infinite;box-shadow:0 0 14px rgba(255,0,0,0.25);}
@keyframes glow{0%{box-shadow:0 0 6px rgba(255,0,0,0.2);}50%{box-shadow:0 0 22px rgba(255,0,0,0.45);}100%{box-shadow:0 0 6px rgba(255,0,0,0.2);}}

/* èµ¤è­¦å‘Šãƒ¢ãƒ¼ãƒ‰ */
.red-alert{background:#2b0000!important;}
.red-alert *{color:#ffb8b8!important;}
.red-alert .pulsing{animation:pulse .6s infinite;}
@keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.03);}100%{transform:scale(1);}}

/* layout */
.row{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start;margin-top:18px;}
.col{flex:1 1 300px;}

/* PLANS */
.plans{margin-top:18px;}
.plans h2{text-align:center;font-size:1.25rem;margin-bottom:12px;}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:12px;align-items:center;}
.controls input, .controls select{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#111;color:white;}
.plan-list{display:grid;grid-template-columns:1fr;gap:12px;}
@media(min-width:900px){.plan-list{grid-template-columns:repeat(3,1fr);}}
.plan-card{background:#131313;border-radius:12px;padding:12px;box-shadow:0 0 12px rgba(255,255,255,0.04);text-align:center;transition:.25s;position:relative;overflow:hidden;}
.plan-card:hover{transform:translateY(-6px);box-shadow:0 0 28px rgba(255,255,255,0.06);}
.plan-card img{width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:8px;}
.plan-card .price{font-size:1.05rem;margin:6px 0;color:#ffd166;}
.favorite-btn{position:absolute;top:10px;right:10px;font-size:1.2rem;cursor:pointer; opacity:0.9;padding:6px;border-radius:8px;background:rgba(0,0,0,0.28);}
.favorite-btn.active{color:#ff4d4d;background:rgba(255,255,255,0.03);}

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.checkbox-group{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.checkbox-group label{display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;font-size:0.95rem;}
.checkbox-group input[type="checkbox"]{accent-color:#ffaa00;transform:scale(1.02);}

/* ãŠæ°—ã«å…¥ã‚Šãƒšãƒ¼ã‚¸ */
#favoritePage{display:none;padding:12px 0;}
#favoritePage h2{text-align:center;margin-bottom:12px;}
#favoriteList{display:grid;grid-template-columns:1fr;gap:12px;}
@media(min-width:900px){#favoriteList{grid-template-columns:repeat(3,1fr);}}

/* FORM */
.form-section{margin-top:20px;}
.form-section h2{font-size:1.1rem;margin-bottom:10px;}
form{display:flex;flex-direction:column;gap:10px;margin-top:8px;}
input,select,textarea{padding:12px 14px;border:none;border-radius:10px;background:#181818;color:white;font-size:0.98rem;border:1px solid rgba(255,255,255,0.04);}
input::placeholder{opacity:0.6;}
button.submitBtn{padding:12px;background:#00b7ff;border:none;border-radius:10px;color:black;font-size:1rem;cursor:pointer;transition:.2s;}
button.submitBtn:hover{background:#33c8ff;transform:translateY(-2px);}

/* é€ä¿¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.progress-container{width:100%;background:#222;height:12px;border-radius:10px;margin-top:10px;overflow:hidden;display:none;position:relative;}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#00b7ff,#44e0ff,#00b7ff);transition:width 0.18s linear;background-size:200% 100%;}
@keyframes wave {0%{background-position:0 0;}100%{background-position:200% 0;}}

/* ã‚¨ãƒ©ãƒ¼ç”»é¢ */
#errorBox{display:none;margin-top:12px;padding:16px;background:#400;border-left:6px solid red;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6);}

/* ã‚¨ãƒ©ãƒ¼æŒ¯å‹• */
@keyframes vibrate {
  0%{ transform: translateX(0) }
  20%{ transform: translateX(-8px) }
  40%{ transform: translateX(8px) }
  60%{ transform: translateX(-6px) }
  80%{ transform: translateX(6px) }
  100%{ transform: translateX(0) }
}

/* æˆåŠŸãƒœãƒƒã‚¯ã‚¹ */
.success{display:none;margin-top:12px;padding:16px;background:linear-gradient(135deg,#062,#098);border-left:6px solid #2f6;border-radius:10px;color:#051505;}

/* èŠ±ç«ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ */
#fireworksCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:9999;display:none;}

/* ã‚³ãƒ³ãƒ•ã‚§ãƒ†ã‚£ (è£œåŠ©) */
.confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;overflow:hidden;z-index:9998;}

/* å…¨ãƒœã‚¿ãƒ³å…±é€š */
button, .glow-btn, #alertToggle, .submitBtn{
  border:none;border-radius:12px;padding:8px 14px;font-size:0.95rem;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#1e1e1e,#2c2c2c);color:white;letter-spacing:0.4px;transition:0.2s ease;box-shadow:0 0 10px rgba(255,255,255,0.08);
}

/* èµ¤è­¦å‘Šæ™‚ */
.red-alert button, .red-alert .submitBtn{
  background:linear-gradient(135deg,#4d0000,#7a0000) !important;box-shadow:0 0 14px red !important;
}

/* extra */
.back-btn{display:inline-block;margin-top:12px;background:#444;padding:8px 12px;border-radius:8px;text-decoration:none;color:white;}
.plans-extra{margin-top:20px;display:grid;grid-template-columns:1fr;gap:10px;}
@media(min-width:900px){.plans-extra{grid-template-columns:repeat(2,1fr);}}

/* responsive tweaks */
@media(max-width:640px){
  .hero h1{font-size:1.6rem;}
  .plan-card img{height:120px;}
  .wrapper{padding:12px;}
}
</style>
</head>
<body>
<div class="wrapper">

<section class="hero pulsing">
  <h1>ã‚¹ãƒ†ã‚¤ãƒ›ãƒ¼ãƒ ãƒ„ã‚¢ãƒ¼ã‚º</h1>
  <p>æ—…è¡Œã—ãªã„ã¨ã„ã†æœ€é«˜ã®è´…æ²¢ã€‚ã‚ãªãŸã®å®¶ãŒã€ä»Šæ—¥ã‹ã‚‰ä¸–ç•Œæœ€é«˜ã®è¦³å…‰åœ°ã«ã€‚</p>
  <button id="alertToggle">ğŸ”´ èµ¤è­¦å‘Šãƒ¢ãƒ¼ãƒ‰</button>
  <div style="margin-top:12px;">
    <button id="goFavorite" style="margin-top:6px;padding:8px 14px;font-size:0.95rem;border-radius:10px;border:none;cursor:pointer;background:#ffaa00;color:black;">â­ ãŠæ°—ã«å…¥ã‚Šã‚’è¦‹ã‚‹</button>
    <a href="#" id="backToMain" class="back-btn" style="display:none;">â† å…ƒã®ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>
  </div>
</section>

<section class="plans" id="planSection">
  <h2>ãŠã™ã™ã‚åœ¨å®…ãƒ—ãƒ©ãƒ³ï¼ˆè¨ˆ 12 ãƒ—ãƒ©ãƒ³ï¼‰</h2>

  <div class="controls" aria-hidden="false" style="margin-top:8px;">
    <input id="searchInput" type="search" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šNetflixã€å¸ƒå›£ã€æ¸©æ³‰ï¼‰" style="min-width:180px;">
    <!-- è¤‡æ•°ã‚«ãƒ†ã‚´ãƒªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
    <div class="checkbox-group" id="categoryFilters" aria-label="ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿">
      <label><input type="checkbox" value="relax"> ç™’ã—ç³»</label>
      <label><input type="checkbox" value="comfy"> çœã‚¨ãƒç³»</label>
      <label><input type="checkbox" value="wild"> å¦„æƒ³ç³»</label>
      <label><input type="checkbox" value="fun"> ãŠãµã–ã‘ç³»</label>
    </div>

    <select id="sortSelect" aria-label="ä¸¦ã¹æ›¿ãˆ">
      <option value="default">ä¸¦ã¹æ›¿ãˆ: æ¨å¥¨é †</option>
      <option value="price-asc">ä¾¡æ ¼: å®‰ã„é †</option>
      <option value="price-desc">ä¾¡æ ¼: é«˜ã„é †</option>
      <option value="name-asc">åå‰: Aâ†’Z</option>
      <option value="name-desc">åå‰: Zâ†’A</option>
      <option value="price-band">ä¾¡æ ¼å¸¯é †ï¼ˆå®‰ã„â†’æ™®é€šâ†’é«˜ã„ï¼‰</option>
      <option value="random">ãƒ©ãƒ³ãƒ€ãƒ </option>
    </select>

    <button id="clearFilters" style="background:#333;color:white;padding:8px 10px;border-radius:8px;">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
  </div>

  <div class="plan-list" id="planList" aria-live="polite"></div>
</section>

<section id="favoritePage">
  <h2>ãŠæ°—ã«å…¥ã‚Šä¸€è¦§</h2>
  <div id="favoriteList"></div>
</section>

<section class="form-section">
  <h2>äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ </h2>

  <form id="reserveForm" novalidate>
    <input id="name" type="text" name="name" placeholder="åå‰" required>
    <input id="email" type="email" name="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
    <input id="tel" type="text" name="tel" placeholder="é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰">
    <input id="place" type="text" name="place" placeholder="è¡ŒããŸã„å ´æ‰€ï¼ˆå®¶ã®ä¸­ã§ã‚‚OKï¼‰" required>

    <select id="level" name="level" required>
      <option value="">è¡ŒããŸã„åº¦</option>
      <option value="0">0ï¼ˆè¡Œã‹ãªã„ï¼‰</option>
      <option value="1">1ï¼ˆã¾ã‚è¡Œã‹ãªã„ï¼‰</option>
      <option value="2">2ï¼ˆã‚„ã£ã±è¡Œã‹ãªã„ï¼‰</option>
      <option value="3">3ï¼ˆçµ¶å¯¾è¡Œã‹ãªã„ï¼‰</option>
    </select>

    <button class="submitBtn" type="submit">é€ä¿¡</button>
  </form>

  <div class="progress-container" id="progressArea">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <div id="errorBox" role="alert" aria-live="assertive"></div>
  <div id="successBox" class="success" role="status" aria-live="polite"></div>
  <div id="confetti" class="confetti" aria-hidden="true"></div>
</section>

<footer style="margin-top:24px;text-align:center;opacity:0.6;">Â© 2025 StayHomeTours</footer>
</div>

<!-- èŠ±ç«ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ -->
<canvas id="fireworksCanvas"></canvas>

   <script>
/* ----------------------------
  ãƒ‡ãƒ¼ã‚¿ï¼š12ãƒ—ãƒ©ãƒ³ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
---------------------------- */
const PLANS = [
  { id:1, name:"å¸ƒå›£ã§æ¥µä¸Šæ¸©æ³‰", desc:"æ¯›å¸ƒã«åŒ…ã¾ã‚Œã¦æ¸©æ³‰æ°—åˆ†ã€‚å…¥æµ´å‰¤ã§æ—…æƒ…ã‚’æ¼”å‡ºã€‚", category:"relax", price:1200, img:"https://picsum.photos/seed/onnsen/600/400" },
  { id:2, name:"ãƒ™ãƒ©ãƒ³ãƒ€BBQå¦„æƒ³", desc:"ãƒ™ãƒ©ãƒ³ãƒ€ã‚’ä½¿ã£ãŸå¦„æƒ³BBQã€‚ç…™ã¯å¿ƒã®ä¸­ã§ã€‚", category:"wild", price:300, img:"https://picsum.photos/seed/bbq/600/400" },
  { id:3, name:"Netflixãƒãƒ©ã‚½ãƒ³", desc:"ã‚½ãƒ•ã‚¡ã§ä¸–ç•Œã‚’å‘¨éŠã€‚ãƒãƒƒãƒ—ã‚³ãƒ¼ãƒ³ä»˜ãã€‚", category:"comfy", price:0, img:"https://picsum.photos/seed/netflix/600/400" },
  { id:4, name:"ãŠãµã–ã‘ä»®è£…ãƒ„ã‚¢ãƒ¼", desc:"å®¶ã®ä¸­ã§ã‚³ã‚¹ãƒ—ãƒ¬è¦³å…‰ã€‚å†™çœŸæ˜ ãˆä¿è¨¼ã€‚", category:"fun", price:450, img:"https://picsum.photos/seed/cosplay/600/400" },
  { id:5, name:"æ˜¼å¯ãƒªãƒˆãƒªãƒ¼ãƒˆ", desc:"çª“è¾ºã§é•·ã‚ã®æ˜¼å¯ã€‚ã‚¢ãƒ­ãƒãŒãƒã‚¤ãƒ³ãƒˆã€‚", category:"relax", price:200, img:"https://picsum.photos/seed/nap/600/400" },
  { id:6, name:"çœã‚¨ãƒèª­æ›¸ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸", desc:"é›»æ°—ã‚’ç¯€ç´„ã—ã¤ã¤æœ¬ã®æ—…ã¸ã€‚ãƒ©ãƒ³ãƒ—æ¨å¥¨ã€‚", category:"comfy", price:350, img:"https://picsum.photos/seed/book/600/400" },
  { id:7, name:"ç©ºæƒ³ä¸–ç•Œãƒ„ã‚¢ãƒ¼", desc:"é ­ã®ä¸­ã§ä¸–ç•Œä¸€å‘¨ã€‚ç­†è¨˜å…·ã¨åœ°å›³ã‚’ç”¨æ„ã€‚", category:"wild", price:80, img:"https://picsum.photos/seed/dream/600/400" },
  { id:8, name:"ãƒ‘ã‚¸ãƒ£ãƒã§è´…æ²¢ãƒ‡ã‚£ãƒŠãƒ¼", desc:"å®¶ã®ã‚­ãƒƒãƒãƒ³ã§é«˜ç´šåº—ã‚¯ã‚ªãƒªãƒ†ã‚£ã‚’å†ç¾ã€‚", category:"relax", price:980, img:"https://picsum.photos/seed/dinner/600/400" },
  { id:9, name:"ã‚²ãƒ¼ãƒ å¤§ä¼šãƒ‘ãƒƒã‚¯", desc:"å‹é”ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§é å¾æ°—åˆ†ã€‚æ™¯å“ã¯æ°—æŒã¡ã€‚", category:"fun", price:600, img:"https://picsum.photos/seed/game/600/400" },
  { id:10, name:"çœã‚¨ãƒç‘æƒ³ãƒ–ãƒ¼ã‚¹ãƒˆ", desc:"è–„æš—ã„éƒ¨å±‹ã§ç‘æƒ³ã€‚ãƒãƒƒãƒ†ãƒªãƒ¼ç¯€ç´„æ¨å¥¨ã€‚", category:"comfy", price:150, img:"https://picsum.photos/seed/meditate/600/400" },
  { id:11, name:"å®¤å†…ã‚µãƒ•ã‚¡ãƒªï¼ˆã¬ã„ãã‚‹ã¿ï¼‰", desc:"ã¬ã„ãã‚‹ã¿é”ã¨ã‚¸ãƒ£ãƒ³ã‚°ãƒ«æ•£ç­–ã€‚å­ä¾›å¿ƒã‚’åˆºæ¿€ã€‚", category:"fun", price:220, img:"https://picsum.photos/seed/safari/600/400" },
  { id:12, name:"å¤œæƒ³å¦„æƒ³ã‚·ãƒãƒ", desc:"æš—ã„éƒ¨å±‹ã§è‡ªä½œæ˜ ç”»ã‚’ä¸Šæ˜ ã€‚æ¼”å‡ºã¯ã‚ãªãŸæ¬¡ç¬¬ã€‚", category:"wild", price:720, img:"https://picsum.photos/seed/cinema/600/400" }
];

/* ----------------------------
  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šæ­£è¦åŒ–ï¼ˆå…¨è§’â†’åŠè§’ã€ã‹ãªæ­£è¦åŒ–ãªã©ï¼‰
---------------------------- */
/* å…¨è§’è‹±æ•°å­—è¨˜å·ã‚’åŠè§’ã« */
function toHalfWidth(str){
  // ç°¡æ˜“ç‰ˆï¼šå…¨è§’è‹±æ•°å­—ã¨è¨˜å·ã®å¤‰æ›
  return str.replace(/[\uFF01-\uFF5E]/g, function(ch){
    return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0);
  }).replace(/\u3000/g, ' ');
}

/* ã²ã‚‰ãŒãªã‚’ã‚«ã‚¿ã‚«ãƒŠã«å¤‰æ› */
function hiraToKana(str){
  return str.replace(/[\u3041-\u3096]/g, function(ch){
    return String.fromCharCode(ch.charCodeAt(0) + 0x60);
  });
}

/* å°æ–‡å­—å¤§æ–‡å­—ã€ç©ºç™½é™¤å»ã€é€£ç¶šç©ºç™½æ­£è¦åŒ– */
function normalizeForSearch(s){
  if(!s) return "";
  s = s.toString();
  s = toHalfWidth(s);
  s = s.toLowerCase();
  s = hiraToKana(s); // ã²ã‚‰ãŒãªâ†’ã‚«ã‚¿ã‚«ãƒŠ
  s = s.replace(/\s+/g,' ').trim();
  return s;
}

/* éƒ¨åˆ†ä¸€è‡´ã‹ã©ã†ã‹ï¼ˆæ­£è¦åŒ–æ¸ˆã¿ï¼‰ */
function matchesQuery(itemTextNorm, queryNorm){
  return itemTextNorm.indexOf(queryNorm) !== -1;
}

/* ----------------------------
  çŠ¶æ…‹ (é¸æŠä¸­ã®ãƒ•ã‚£ãƒ«ã‚¿/ã‚½ãƒ¼ãƒˆ/æ¤œç´¢)
---------------------------- */
let state = {
  query: '',
  categories: new Set(), // selected category values
  sort: localStorage.getItem('st_lastSort') || 'default',
};

/* DOM */
const planListEl = document.getElementById('planList');
const searchInput = document.getElementById('searchInput');
const categoryFiltersEl = document.getElementById('categoryFilters');
const sortSelect = document.getElementById('sortSelect');
const clearFiltersBtn = document.getElementById('clearFilters');

sortSelect.value = state.sort;

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŠæ°—ã«å…¥ã‚Šï¼ˆlocalStorageï¼‰ */
const FAVORITE_KEY = "st_favs_v1";
function loadFavs(){ try{ return JSON.parse(localStorage.getItem(FAVORITE_KEY) || "[]"); }catch(e){return [];} }
function saveFavs(arr){ localStorage.setItem(FAVORITE_KEY, JSON.stringify(arr)); }
let favs = new Set(loadFavs());

/* ----------------------------
  ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼š1å›ã§ãƒ•ã‚£ãƒ«ã‚¿â†’æ¤œç´¢â†’ã‚½ãƒ¼ãƒˆ
---------------------------- */
function computeAndRender(){
  const q = normalizeForSearch(state.query);
  // collect selected categories
  const selectedCats = Array.from(state.categories);
  const filterByCategory = selectedCats.length > 0;

  // Pre-normalize plan texts for searching
  const processed = PLANS.map(p=>{
    const text = `${p.name} ${p.desc} ${p.category}`;
    const norm = normalizeForSearch(text);
    return {...p, norm};
  });

  // Filter
  let filtered = processed.filter(p=>{
    // category OR logic
    if(filterByCategory && !selectedCats.includes(p.category)) return false;
    // search
    if(q){
      if(!matchesQuery(p.norm, q)) return false;
    }
    return true;
  });

  // Sort
  switch(state.sort){
    case 'price-asc':
      filtered.sort((a,b)=> a.price - b.price);
      break;
    case 'price-desc':
      filtered.sort((a,b)=> b.price - a.price);
      break;
    case 'name-asc':
      filtered.sort((a,b)=> a.name.localeCompare(b.name, 'ja'));
      break;
    case 'name-desc':
      filtered.sort((a,b)=> b.name.localeCompare(a.name, 'ja'));
      break;
    case 'price-band':
      // price band order: cheap(0-499) -> normal(500-999) -> expensive(1000+)
      function band(p){
        if(p.price >= 1000) return 2;
        if(p.price >= 500) return 1;
        return 0;
      }
      filtered.sort((a,b)=> {
        const ba = band(a), bb = band(b);
        if(ba !== bb) return ba - bb;
        return a.price - b.price;
      });
      break;
    case 'random':
      for(let i=filtered.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [filtered[i], filtered[j]] = [filtered[j], filtered[i]];
      }
      break;
    default:
      // default: recommended â€” keep original order by id
      filtered.sort((a,b)=> a.id - b.id);
  }

  renderPlanList(filtered);
}

/* ç”»é¢æç”» */
function renderPlanList(plans){
  planListEl.innerHTML = '';
  if(plans.length === 0){
    planListEl.innerHTML = `<div style="text-align:center;padding:24px;color:rgba(255,255,255,0.6);">çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚£ãƒ«ã‚¿ã‚„æ¤œç´¢æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }

  const frag = document.createDocumentFragment();
  plans.forEach(p=>{
    const card = document.createElement('article');
    card.className = 'plan-card';
    card.setAttribute('data-id', p.id);

    const favActive = favs.has(p.id.toString()) ? 'active' : '';

    card.innerHTML = `
      <button class="favorite-btn ${favActive}" aria-label="ãŠæ°—ã«å…¥ã‚Š" title="ãŠæ°—ã«å…¥ã‚Š">â¤</button>
      <img src="${p.img}" alt="${p.name}">
      <h3 style="margin:8px 0 4px;">${p.name}</h3>
      <div style="font-size:0.9rem;opacity:0.9;height:44px;overflow:hidden;">${p.desc}</div>
      <div class="price">${p.price === 0 ? 'ç„¡æ–™' : p.price.toLocaleString() + 'å††'}</div>
      <div style="margin-top:8px;font-size:0.85rem;opacity:0.8;">ã‚«ãƒ†ã‚´ãƒª: ${p.category}</div>
    `;
    frag.appendChild(card);

    // favorite toggle
    const favBtn = card.querySelector('.favorite-btn');
    favBtn.addEventListener('click', ()=>{
      toggleFavorite(p.id, favBtn);
    });
  });

  planListEl.appendChild(frag);
}

/* favorite ãƒˆã‚°ãƒ« */
function toggleFavorite(id, btnEl){
  const sid = id.toString();
  if(favs.has(sid)){
    favs.delete(sid);
    btnEl.classList.remove('active');
  } else {
    favs.add(sid);
    btnEl.classList.add('active');
  }
  saveFavs(Array.from(favs));
}

/* ----------------------------
  UI ã‚¤ãƒ™ãƒ³ãƒˆï¼šæ¤œç´¢ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ã§é«˜é€Ÿï¼‰
---------------------------- */
let debounceTimer = null;
function debounce(func, wait){
  return function(...args){
    if(debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=> func.apply(this, args), wait);
  };
}

const onSearchInput = debounce((ev)=>{
  state.query = ev.target.value || '';
  computeAndRender();
}, 120);

searchInput.addEventListener('input', onSearchInput);

/* ã‚«ãƒ†ã‚´ãƒªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ */
categoryFiltersEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
  cb.addEventListener('change', (e)=>{
    const val = e.target.value;
    if(e.target.checked) state.categories.add(val);
    else state.categories.delete(val);
    computeAndRender();
  });
});

/* ã‚½ãƒ¼ãƒˆå¤‰æ›´ */
sortSelect.addEventListener('change', (e)=>{
  state.sort = e.target.value;
  localStorage.setItem('st_lastSort', state.sort);
  computeAndRender();
});

/* ã‚¯ãƒªã‚¢ãƒ•ã‚£ãƒ«ã‚¿ */
clearFiltersBtn.addEventListener('click', ()=>{
  // search
  searchInput.value = '';
  state.query = '';
  // categories
  state.categories.clear();
  categoryFiltersEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
    cb.checked = false;
  });
  // sort reset to default
  state.sort = 'default';
  sortSelect.value = 'default';
  localStorage.setItem('st_lastSort', state.sort);
  computeAndRender();
});

/* åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° */
computeAndRender();

/* ----------------------------
  ãŠæ°—ã«å…¥ã‚Šãƒšãƒ¼ã‚¸åˆ‡æ›¿
---------------------------- */
const goFavBtn = document.getElementById('goFavorite');
const backToMain = document.getElementById('backToMain');
const favPage = document.getElementById('favoritePage');
const favoriteListEl = document.getElementById('favoriteList');
const planSection = document.getElementById('planSection');

function openFavorites(){
  planSection.style.display = 'none';
  favPage.style.display = 'block';
  backToMain.style.display = 'inline-block';
  document.getElementById('goFavorite').style.display = 'none';
  renderFavorites();
}

function closeFavorites(){
  planSection.style.display = '';
  favPage.style.display = 'none';
  backToMain.style.display = 'none';
  document.getElementById('goFavorite').style.display = '';
  computeAndRender();
}

goFavBtn.addEventListener('click', openFavorites);
backToMain.addEventListener('click', (e)=>{
  e.preventDefault();
  closeFavorites();
});

function renderFavorites(){
  favoriteListEl.innerHTML = '';
  const favArr = Array.from(favs);
  if(favArr.length === 0){
    favoriteListEl.innerHTML = `<div style="text-align:center;padding:24px;color:rgba(255,255,255,0.6);">ãŠæ°—ã«å…¥ã‚Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  favArr.forEach(idStr=>{
    const p = PLANS.find(x=> x.id.toString() === idStr);
    if(!p) return;
    const card = document.createElement('article');
    card.className = 'plan-card';
    card.innerHTML = `
      <button class="favorite-btn active" aria-label="ãŠæ°—ã«å…¥ã‚Šè§£é™¤" title="ãŠæ°—ã«å…¥ã‚Šè§£é™¤">â¤</button>
      <img src="${p.img}" alt="${p.name}">
      <h3 style="margin:8px 0 4px;">${p.name}</h3>
      <div style="font-size:0.9rem;opacity:0.9;height:44px;overflow:hidden;">${p.desc}</div>
      <div class="price">${p.price === 0 ? 'ç„¡æ–™' : p.price.toLocaleString() + 'å††'}</div>
      <div style="margin-top:8px;font-size:0.85rem;opacity:0.8;">ã‚«ãƒ†ã‚´ãƒª: ${p.category}</div>
    `;
    frag.appendChild(card);

    const favBtn = card.querySelector('.favorite-btn');
    favBtn.addEventListener('click', ()=>{
      // remove from favs then re-render favorites
      favs.delete(p.id.toString());
      saveFavs(Array.from(favs));
      renderFavorites();
    });
  });
  favoriteListEl.appendChild(frag);
}

/* ----------------------------
  äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ å¼·åŒ–ï¼ˆæ¤œè¨¼ãƒ»é€ä¿¡æ¼”å‡ºãƒ»35%ã‚¨ãƒ©ãƒ¼ï¼‰
---------------------------- */
const form = document.getElementById('reserveForm');
const progressArea = document.getElementById('progressArea');
const progressBar = document.getElementById('progressBar');
const errorBox = document.getElementById('errorBox');
const successBox = document.getElementById('successBox');
const canvas = document.getElementById('fireworksCanvas');
const ctx = canvas.getContext && canvas.getContext('2d');

/* 10å€‹ä»¥ä¸Šã®ã‚¨ãƒ©ãƒ¼ç†ç”± */
const errorReasons = [
  "ã‚µãƒ¼ãƒãƒ¼ãŒå¯ã¦ã„ã¾ã™ã€‚",
